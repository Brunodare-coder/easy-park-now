"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[58],{9376:function(e,t,r){var a=r(5475);r.o(a,"useRouter")&&r.d(t,{useRouter:function(){return a.useRouter}}),r.o(a,"useSearchParams")&&r.d(t,{useSearchParams:function(){return a.useSearchParams}})},8022:function(e,t,r){r.d(t,{AuthProvider:function(){return g},a:function(){return d}});var a=r(7437),s=r(2265),o=r(9376),i=r(257);class n{constructor(){this.token=null,this.errorQueue=[],this.isOnline=navigator.onLine,this.maxQueueSize=100,this.batchSize=10,this.flushInterval=3e4,this.retryDelay=5e3,this.errorCache=new Set,this.cacheExpiry=3e5,this.apiUrl=i.env.NEXT_PUBLIC_API_URL||"http://localhost:5000/api",this.setupEventListeners(),this.startPeriodicFlush(),this.loadQueueFromStorage()}setToken(e){this.token=e}setupEventListeners(){window.addEventListener("error",e=>{this.logError({message:e.message,stack:e.error?.stack,url:e.filename,severity:"ERROR",metadata:{lineno:e.lineno,colno:e.colno,type:"javascript_error"}})}),window.addEventListener("unhandledrejection",e=>{this.logError({message:`Unhandled Promise Rejection: ${e.reason}`,stack:e.reason?.stack,severity:"ERROR",metadata:{type:"promise_rejection",reason:e.reason}})}),window.addEventListener("online",()=>{this.isOnline=!0,this.flushQueue()}),window.addEventListener("offline",()=>{this.isOnline=!1}),window.addEventListener("beforeunload",()=>{this.saveQueueToStorage(),this.errorQueue.length>0&&this.sendBeacon()})}logError(e){let t={id:this.generateId(),message:e.message,stack:e.stack,url:e.url||window.location.href,userAgent:navigator.userAgent,timestamp:e.timestamp||new Date().toISOString(),severity:e.severity||"ERROR",metadata:{...e.metadata,viewport:{width:window.innerWidth,height:window.innerHeight},screen:{width:screen.width,height:screen.height}},attempts:0,maxAttempts:3},r=this.hashError(t);!this.errorCache.has(r)&&(this.errorCache.add(r),setTimeout(()=>{this.errorCache.delete(r)},this.cacheExpiry),this.addToQueue(t),this.isOnline&&this.flushQueue())}logApiError(e,t){this.logError({message:`API Error: ${e.status} ${e.statusText}`,url:e.url,severity:e.status>=500?"ERROR":"WARNING",metadata:{type:"api_error",status:e.status,statusText:e.statusText,requestData:t?JSON.stringify(t).substring(0,1e3):void 0}})}logNetworkError(e,t){this.logError({message:`Network Error: ${e.message}`,stack:e.stack,url:t,severity:"ERROR",metadata:{type:"network_error",name:e.name}})}logUserActionError(e,t,r){this.logError({message:`User Action Error: ${e} - ${t.message}`,stack:t.stack,severity:"WARNING",metadata:{type:"user_action_error",action:e,context:r}})}addToQueue(e){this.errorQueue.length>=this.maxQueueSize&&this.errorQueue.shift(),this.errorQueue.push(e)}async flushQueue(){if(this.isOnline&&0!==this.errorQueue.length&&this.token)for(let e of this.errorQueue.splice(0,this.batchSize))try{await this.sendError(e)}catch(t){e.attempts++,e.attempts<e.maxAttempts?this.errorQueue.unshift(e):console.warn("Failed to send error after max attempts:",e.message)}}async sendError(e){let t=await fetch(`${this.apiUrl}/error-logs`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify({message:e.message,stack:e.stack,url:e.url,userAgent:e.userAgent,timestamp:e.timestamp,severity:e.severity,metadata:e.metadata})});if(!t.ok)throw Error(`Failed to send error: ${t.status}`)}sendBeacon(){if(!this.token||0===this.errorQueue.length)return;let e=JSON.stringify({errors:this.errorQueue.map(e=>({message:e.message,stack:e.stack,url:e.url,userAgent:e.userAgent,timestamp:e.timestamp,severity:e.severity,metadata:e.metadata}))});navigator.sendBeacon(`${this.apiUrl}/error-logs/batch`,e)}startPeriodicFlush(){setInterval(()=>{this.flushQueue()},this.flushInterval)}generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}hashError(e){return btoa(`${e.message}-${e.url}-${e.stack?.split("\n")[0]||""}`).replace(/[^a-zA-Z0-9]/g,"").substring(0,32)}saveQueueToStorage(){try{localStorage.setItem("errorQueue",JSON.stringify(this.errorQueue))}catch(e){console.warn("Failed to save error queue to storage:",e)}}loadQueueFromStorage(){try{let e=localStorage.getItem("errorQueue");e&&(this.errorQueue=JSON.parse(e),localStorage.removeItem("errorQueue"))}catch(e){console.warn("Failed to load error queue from storage:",e)}}clearQueue(){this.errorQueue=[],this.errorCache.clear(),localStorage.removeItem("errorQueue")}getQueueStatus(){return{queueLength:this.errorQueue.length,isOnline:this.isOnline,hasToken:!!this.token}}}let u=new n,l=e=>u.setToken(e);var h=r(257);let c=(0,s.createContext)(void 0),d=()=>{let e=(0,s.useContext)(c);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e},m=h.env.NEXT_PUBLIC_API_URL||"http://localhost:5000/api",g=e=>{let{children:t}=e,[r,i]=(0,s.useState)(null),[n,u]=(0,s.useState)(null),[h,d]=(0,s.useState)(!0),g=(0,o.useRouter)(),f=!!r&&!!n;(0,s.useEffect)(()=>{(async()=>{try{let e=localStorage.getItem("auth_token"),t=localStorage.getItem("auth_user");e&&t&&(u(e),i(JSON.parse(t)),l(e),await p(e))}catch(e){console.error("Auth initialization error:",e),localStorage.removeItem("auth_token"),localStorage.removeItem("auth_user")}finally{d(!1)}})()},[]);let p=async e=>{try{let t=await fetch(`${m}/auth/me`,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!t.ok)throw Error("Token verification failed");let r=await t.json();if(r.success&&r.data.user)i(r.data.user);else throw Error("Invalid user data")}catch(e){throw console.error("Token verification error:",e),u(null),i(null),localStorage.removeItem("auth_token"),localStorage.removeItem("auth_user"),e}},w=async(e,t)=>{try{d(!0);let r=await fetch(`${m}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})}),a=await r.json();if(!r.ok)throw Error(a.message||"Login failed");if(a.success&&a.data.user&&a.data.token){let{user:e,token:t}=a.data;i(e),u(t),l(t),localStorage.setItem("auth_token",t),localStorage.setItem("auth_user",JSON.stringify(e));let r="ADMIN"===e.role?"/admin":"/dashboard";g.push(r)}else throw Error("Invalid response data")}catch(e){throw console.error("Login error:",e),e}finally{d(!1)}},v=async e=>{try{d(!0);let t=await fetch(`${m}/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),r=await t.json();if(!t.ok)throw Error(r.message||"Registration failed");if(r.success&&r.data.user&&r.data.token){let{user:e,token:t}=r.data;i(e),u(t),l(t),localStorage.setItem("auth_token",t),localStorage.setItem("auth_user",JSON.stringify(e)),g.push("/dashboard")}else throw Error("Invalid response data")}catch(e){throw console.error("Registration error:",e),e}finally{d(!1)}},y=()=>{i(null),u(null),localStorage.removeItem("auth_token"),localStorage.removeItem("auth_user"),g.push("/")},k=async()=>{try{if(!n)throw Error("No token available");let e=await fetch(`${m}/auth/refresh`,{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"}}),t=await e.json();if(!e.ok)throw Error(t.message||"Token refresh failed");if(t.success&&t.data.token){let e=t.data.token;u(e),localStorage.setItem("auth_token",e)}else throw Error("Invalid refresh response")}catch(e){throw console.error("Token refresh error:",e),y(),e}};return(0,s.useEffect)(()=>{if(n)try{let e=JSON.parse(atob(n.split(".")[1])),t=1e3*e.exp,r=Date.now(),a=t-r-3e5;if(a>0){let e=setTimeout(()=>{k().catch(console.error)},a);return()=>clearTimeout(e)}y()}catch(e){console.error("Token parsing error:",e),y()}},[n]),(0,a.jsx)(c.Provider,{value:{user:r,token:n,isLoading:h,isAuthenticated:f,login:w,register:v,logout:y,updateUser:e=>{if(r){let t={...r,...e};i(t),localStorage.setItem("auth_user",JSON.stringify(t))}},refreshToken:k},children:t})}}}]);